services:
  - type: web
    name: wabi-backend
    runtime: node

    # Build the frontend, then backend dependencies using Bun
    buildCommand: |
      set -e
      echo "=== Installing Bun ===" && \
      npm install -g bun && \
      echo "=== Building frontend ===" && \
      cd frontend && \
      bun install && \
      bun run build && \
      ls -la build/ && \
      echo "=== Frontend built successfully ===" && \
      cd ../backend && \
      echo "=== Installing backend dependencies ===" && \
      bun install --production && \
      echo "=== Build complete ==="

    # Start the backend server (serves both frontend + API)
    # Using Bun runtime for better performance
    startCommand: bun /app/backend/src/server.ts
    
    # Environment variables
    envVars:
      - key: PORT
        value: 10000
      
      # Static files directory - explicitly set for Render
      - key: STATIC_DIR
        value: /app/frontend/build
      
      # Frontend URL for CORS (Render domain)
      - key: FRONTEND_URL
        value: https://wabi.onrender.com
      
      # Public URL for Socket.IO auto-detection
      - key: PUBLIC_URL
        value: https://wabi.onrender.com

